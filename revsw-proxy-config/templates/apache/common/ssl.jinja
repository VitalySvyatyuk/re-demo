{% set ssl_ciphers = "\"EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA 3DES RC4 !aNULL !eNULL !LOW !MD5 !EXP !PSK !SRP !DSS +3DES 3DES +RC4 RC4\"" %}

{% macro _do_setup_no_proxy(this, cert_dir) %}
    SSLEngine On
    # Disable SSLv2/3 because of SNI, which requires TLS
    SSLProtocol All -SSLv2 -SSLv3
    # Mitigate CRIME attack
    SSLCompression off
    # Use stronger ciphers, which may mitigate BEAST attacks
    SSLHonorCipherOrder on
    SSLCipherSuite {{ssl_ciphers}}
    SSLCACertificateFile {{cert_dir}}/ca-bundle.crt
    SSLCertificateFile {{cert_dir}}/server.crt
    SSLCertificateKeyFile {{cert_dir}}/server.key
{%- endmacro %}

{% macro _do_setup_proxy_only(this) %}
    SSLProxyEngine On
    # Disable SSLv2/3 because of SNI, which requires TLS
    SSLProxyProtocol All -SSLv2 -SSLv3
    SSLProxyCipherSuite {{ssl_ciphers}}
    SSLProxyCheckPeerName Off
    SSLProxyCheckPeerCN Off
{%- endmacro %}

{% macro setup_no_proxy(this) %}
    # Begin SSL setup (no proxy)
{{  _do_setup_no_proxy(this, "/opt/revsw-config/apache/" + GLOBAL_SITE_NAME + "/certs") }}
    # End SSL setup
{%- endmacro %}

{% macro setup_proxy_only(this) %}
    # Begin SSL setup (proxy-only)
{{  _do_setup_proxy_only(this) }}
    # End SSL setup
{%- endmacro %}

{% macro setup(this) %}
    # Begin SSL setup
{{  _do_setup_no_proxy(this, "/opt/revsw-config/apache/" + GLOBAL_SITE_NAME + "/certs") }}
{{  _do_setup_proxy_only(this) }}
    # End SSL setup
{%- endmacro %}

{% macro setup_bp_co(this) %}
    # Begin SSL setup
{{  _do_setup_no_proxy(this, "/opt/revsw-config/apache/co-certs") }}
{{  _do_setup_proxy_only(this) }}
    # End SSL setup
{%- endmacro %}
