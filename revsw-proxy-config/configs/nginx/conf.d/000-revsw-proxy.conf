#
# Generic Rev proxy configuration commands.
#
# This file is deployed via package revsw-proxy-config.
#

proxy_cache_path /var/lib/nginx/cache keys_zone=cache:10m;

keepalive_requests 500;

resolver 127.0.0.1 8.8.8.8 ipv6=off;

variables_hash_bucket_size 256;

# GeoIP setup
geoip_city /opt/revsw-config/apache/GeoLite2-City.dat;

# Custom vhost for Varnish requests generated as the result of origin redirects
server {
    listen 127.0.0.1:9081;
    allow all;
    access_log off;
    location / {
        proxy_pass http://$host$uri$is_args$args;
        # Disable buffering so nginx will not try to write the data to a temporary local file - provides traffic back-pressure feature
        proxy_buffering on;
        proxy_limit_rate 150k;
        proxy_max_temp_file_size 0;
    }
    pagespeed off;
}

# Needs to exist and be writable by nginx. Use tmpfs for best performance.
pagespeed FileCachePath /var/run/ngx_pagespeed_cache;
# Retrieve compressed objects from the origin
pagespeed FetchWithGzip on;

#
# Catch-all HTTP and HTTPS servers for BP part
#
server {

   listen 80 default_server;
   server_name _;

   location / {
       return 503;
   }
   pagespeed off;
}

server {
    listen 443 ssl http2;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_certificate /opt/revsw-config/apache/generic-site/certs/server-chained.crt;
    ssl_certificate_key /opt/revsw-config/apache/generic-site/certs/server.key;

    server_name _;

    location / {
       return 503;
    }
    pagespeed off;
}

#
# Catch-all servers for CO part
#
server {
   listen 18000 default_server;
   server_name _;
   underscores_in_headers on;
   location / {
       return 503 "No such site. Check the URL spelling.";
   }
   pagespeed off;
}

server {
    listen 19000 ssl http2;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_certificate /opt/revsw-config/apache/generic-site/certs/server-chained.crt;
    ssl_certificate_key /opt/revsw-config/apache/generic-site/certs/server.key;
    server_name _;
    underscores_in_headers on;
    location / {
       return 503 "No such site. Check the URL spelling.";
    }
    pagespeed off;
}

#
# This block provides the Nagios server with access to Nginx status page
#
server {
    listen  80;
    server_name nginx-status-monitor.revsw.net;
    allow  all;

    # Enabled nginx status page (using by Nagios for nginx status monitoring)
    location /nginx_status {
       # Turn on stats
       stub_status on;
       allow 54.88.56.156;
       deny all;
    }
    pagespeed off;
}
